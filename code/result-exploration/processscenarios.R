processscenarios <- function()
{
  
  # Take the data generated by the scenario simulations and bring them in a form 
  # that can easily be used by the shiny app
  #final result for shiny app should be a large data frame with these columns: 
  #Location(State), Scenario, Date
  #Variable name (Daily Cases, Weekly Deaths, etc.), Variable type (e.g. ci5, ci95, mean), value
  #could also add Data Source,  but will likely not do multiple data sources for initial iteration
  
  library('dplyr')
  library('here')
  library('purrr')
  
  #load data for US population size per state so we have all state names and their population sizes
  us_popsize <- readRDS(here("data","us_popsize.rds")) %>% rename(state_abr = state, state = state_full)
  statenames = us_popsize$state
  
  # loop over all states
  all_df = NULL
  for (state_now in statenames)
  {
    print(sprintf('starting state %s',state_now))
    #find all simulation scenario files for current state
    #make regex pattern
    filepattern = paste0("\\b",state_now, ".*simulation-scenarios.rds")
    files = list.files(here('output'),pattern = filepattern, full.names = TRUE) #find all files for this state
    
    if (length(files) == 0) #if there is no file for this state, skip rest of this iteration, move to next
    {
      next
    }
    
    newest_ind = which.max(file.mtime(files)) #find most recent file based on time stamp
    scenario_res <- readRDS(files[newest_ind]) #load most recent file for this state
  
    # combining all simulations for all scenarios into a large data frame
    # scenario will be a column, 
    scenario_df = NULL
    for (n in 1:length(scenario_res))  #loop over each scenario
    {
      x = scenario_res[[n]]
      sims = x$sims
      
      res_df <- sims %>%
                rename( id = ".id") %>% 
                mutate(Date = rep(x$dates,max(id))) %>% 
                select(-time) %>%
                pivot_longer(cols = -c("id","Date"),  names_to = "Variable", values_to = "Value") %>%
                group_by(Variable, Date) %>%
                summarise(lower = ceiling(quantile(Value, 0.1)),
                  ptvalue = ceiling(mean(Value)),
                  upper = ceiling(quantile(Value, 0.9))) %>%
                ungroup() %>%
                pivot_longer(-c("Variable","Date"), names_to = 'Var_Type', values_to = "Value") %>%
                mutate(Scenario = x$scenario, Location = state_now) 
      
      scenario_df = rbind(scenario_df, res_df) #combine all scenarios  
      
    }  #end loop over scenarios
  all_df = rbind(all_df, scenario_df) #combine all states  
  } #end loop over states 

  filename = here('output','results_for_shiny.rds')
  saveRDS(all_df,filename)  
  
} #end main function