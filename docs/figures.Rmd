---
title: "Figures"
output: html_notebook
author: Eric Marty
---


```{r setup, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, out.width = "100%")
library(here)
library(tidyverse)
library(cowplot)
library(yardstick)
# library(ggpubr)
library(ggstatsplot)
source(here::here("code/result-exploration/getReff.R"))

```

```{r data}
all_files <- list.files(path = here::here("output/current/"), pattern = ".csv")
param_files <- list.files(path = here::here("output/current/"), pattern = "params-natural.rds")
state_summaries <- tibble()
state_parameters <- tibble()
state_logliks <- tibble()
statedf <-readRDS(here::here("output/current", "statedf.rds"))
statevec <- gsub(".csv","",all_files)
allstates_pop <- statedf %>% filter(state_full %in% statevec) %>% pull(total_pop) %>% sum()

for(i in 1:length(all_files)) {
  do_file <- all_files[i]
  location <- sub(".csv", "", do_file)
  state_metadata <- statedf %>% filter(state_full == sub(".csv", "", do_file))
  state_pop <- state_metadata %>% pull(total_pop)
  state_initR0 <- state_metadata %>% pull(initR0)
  state_beta_s <- (state_initR0*.1)
  
  tmpparamfile <- here::here("output/current", param_files[i])
  # tmp state params
  statepars <- readRDS(tmpparamfile) 

  statepars_fixed <- statepars %>% 
    rownames_to_column(var = "param") %>% 
    dplyr::filter(is_fitted == "no") %>% 
    select(param,X1) %>% 
    pivot_wider(values_from = X1, names_from = param) %>% 
    select(-c(MIF_ID, LogLik, LogLik_SE))

  statepars_fitted <- statepars %>% 
    rownames_to_column(var = "param") %>% 
    dplyr::filter(is_fitted == "yes") %>% 
    select(param,X1) %>% 
    pivot_wider(values_from = X1, names_from = param)
  
  statepars_allmle <- bind_cols(statepars_fixed,statepars_fitted)
  
  # results

  tmpfile <- here::here("output/current", do_file)
  tmp <- read.csv(tmpfile) %>% mutate(date = as.Date(date))
  firstcasedate <- tmp$date %>% min()
  tmp <- tmp %>%
    filter(sim_type == "status_quo" | is.na(sim_type),
           variable %in% c("daily_cases", "daily_deaths", "daily_all_infections", 
                           "actual_daily_cases", "actual_daily_deaths",
                           "mobility_trend", "latent_trend", "combined_trend",
                           "cumulative_all_infections", "cumulative_deaths")) %>%
    dplyr::select(location, sim_type, period, date, variable, mean_value) %>% 
    pivot_wider(names_from = variable, values_from = mean_value) %>%
    # calculate prevalence
    mutate(prevalence = daily_all_infections / (state_pop-cumulative_deaths)) %>% 
    # calculate omega
    mutate(omega = combined_trend * statepars_allmle$beta_s) %>% 
    # calculate mean S
    mutate(S = state_pop - cumulative_all_infections) %>% 
    mutate(susceptible_fraction = S / (state_pop - cumulative_deaths)) %>% 
    # calculate q
    mutate(q = get_q(t = as.numeric(date-firstcasedate), params = statepars_allmle)) %>%
    # calculate s
    mutate(s = get_s(t = as.numeric(date-firstcasedate), params = statepars_allmle)) %>%
    # calculate mean R_e
    mutate(R_e = getReff(S = S, 
                         omega = omega,
                         q = q,
                         s = s,
                         params = statepars_allmle)) %>%
    pivot_longer(cols = !c(location, sim_type, period, date), 
                 names_to = "variable", 
                 values_to = "mean_value",
                 values_drop_na = TRUE)

  state_summaries <- bind_rows(state_summaries, tmp)
}

# # Fixed parameters table
# betas_names <- rnms[grep("b[0-9]+", rnms)] # find parameters starting with b followed by any number
# spline_coefficients <- paste("Spline coefficient", gsub("b","", betas_names))
# names(spline_coefficients) <- betas_names
# 
# params_vec <- c(MIF_ID = "MIF id", 
#                 LogLik = "Log Likelihood", 
#                 LogLik_SE = "SE of Log Likelihood", 
#                 beta_s = "Transmission rate",
#                 # Relative Transmissibility
#                 frac_trans_e = "Relative transmissibility of latent infections",
#                 frac_trans_a = "Relative transmissibility of asymptomatic individuals",
#                 frac_trans_c = "Relative transmissibility of detected symptomatic individuals post-reporting",
#                 frac_trans_h = "Relative transmissibility of hospitalized individuals",
#                 # Time in compartments
#                 time_e = "Time spent in latent compartments (days)",
#                 time_a = "Time spent in asymptomatic compartments (days)",
#                 time_su = "Time spent in symptomatic, undetected compartments (days)",
#                 time_sd = "Time spent in symptomatic, detected compartments (days)",
#                 time_c = "Time spent in diagnosed cases compartments (days)",
#                 time_h = "Time spent in hospitalized compartments (days)",
#                 # Detection time
#                 max_diag_factor = "Maximum for factor by which movement through Isd happens faster (quicker diagnosis)",
#                 diag_rampup = "Rate at which faster diagnosis ramps up to max",
#                 t_half_diag = "Time at which diagnosis is at 50% of max (in days since t = 1)",
#                 # Detection fraction
#                 max_detect_frac = "Maximum fraction of cases that are detected",
#                 detect_rampup = "Speed at which fraction detected ramps up",
#                 t_half_detect = "Time at which infection detection fraction is at 50% of max (in days since t = 1)",
#                 base_detect_frac = "Minimum fraction detected at t = 1",
#                 # Fraction asymptomatic
#                 frac_asym = "Fraction of latent infections that move to asymptomatic",
#                 # Fraction hosptilized
#                 frac_hosp = "Fraction of detected cases that are hospitalized",
#                 # Fraction of hospitalizations that result in death
#                 min_frac_dead = "Maximum fraction of hospitalizations that result in death",
#                 max_frac_dead = "Maximum fraction of hospitalizations that result in death",
#                 log_half_dead = "Time at which death fraction is at 50% of max (in days since t = 1)",
#                 # Dispersion parameters
#                 theta_cases = "Dispersion parameter for case reporting observation process",
#                 theta_hosps = "Dispersion parameter for hospitalization reporting observation process",
#                 theta_deaths = "Dispersion parameter for death reporting obsercation process",
#                 sigma_dw = "Variance of the stochastics process noise",
#                 # Spline coefficients
#                 spline_coefficients,
#                 # Initial conditions
#                 S_0 = "Initial number of susceptible individuals on t = 1",
#                 E1_0 = "Initial number of latent infectious individuals on t = 1",
#                 Ia1_0 = "Initial number of asymptomatic individuals on t = 1",
#                 Isu1_0 = "Initial number of symptomatic, undetected individuals on t = 1",
#                 Isd1_0 = "Initial number of symptomatic, detected individuals on t = 1",
#                 C1_0 = "Initial number of diagnosed cases on t = 1",
#                 H1_0 = "Initial number of hospitalized cases on t = 1",
#                 R_0 = "Initial number of recovered individuals on t = 1",
#                 D_0 = "Initial number of deaths after hospitalization on t = 1",
#                 trend_start = "Trend")
# 
# tmpparams <- readRDS(tmpparamfile)
# rnms <- row.names(tmpparams)
# params_map <- tibble(Parameter = names(params_vec),
#                      Description = params_vec)
# fixed_parameters <- tmpparams %>%
#   mutate(Parameter = rnms) %>%
#   filter(is_fitted == "no") %>%
#   dplyr::select(-is_fitted) %>%
#   gather("key", "value", -Parameter) %>%
#   filter(key == "X1") %>%
#   left_join(params_map, by = "Parameter") %>%
#   filter(!Parameter %in% c("MIF_ID", "LogLik", "LogLik_SE", "trend_start", "theta_hosps", "S_0")) %>%
#   dplyr::select(Parameter, Description, value) %>%
#   mutate(Parameter = ifelse(Parameter == "E1_0", "L1_0", Parameter))

# Key Dates
future <- state_summaries %>% filter(period == "Future") %>% pull(date) %>% range()
burnin <- c(state_summaries %>% pull(date) %>% min(), as.Date("2020-03-01"))
sample_period <- c(as.Date("2020-03-01"),as.Date("2020-12-31"))

```

# Mobility, Latent Trend and Omega for all states

a) Mobility trend for all states ($\phi$). Covariate that describes human mobility. These data come from <a href="https://www.unacast.com/" target="_blank">Unacast</a>. We smooth the raw data from Unacast using a spline fit, resulting in the trajectories of human movement shown below. This covariate is used to reduce baseline transmission. Here we show the mobility trends from all 50 states. b) latent trend for all states ($\psi$). c) Relativie transmissibility ($\omega$) for all states. In each subplot, the read line is a non-weighted mean of all states.

```{r covariate, fig.height=3, fig.width=7, eval = TRUE}
all_phi <- state_summaries %>%
  filter(variable == "mobility_trend") %>%
  dplyr::select(location, date, mean_value) %>%
  rename(phi = mean_value) %>% 
  filter(date <= Sys.Date())

mean_phi <- all_phi %>% group_by(date) %>% summarise(phi = mean(phi))

g_phi <- ggplot(all_phi, aes(x = date, y = phi, color = location)) +
  geom_line(size = 0.5) +
  # ylab("Human movement\n(% of normal)") +
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  scale_color_viridis_d(option = "D", direction = -1, alpha = .6, end = .75) +
  # theme_dark(base_line_size = 0.5) +
  geom_line(data = mean_phi, alpha = .6, size = 2, color = 'red') +
  # geom_rect(aes(xmin=future[1], xmax=future[2], ymin=0, ymax=1)) +
  annotate("rect", xmin = future[1], xmax = future[2], ymin = 0, ymax = 1, alpha = .2) +
  theme_minimal() +
  guides(color = FALSE)

p_phi <- g_phi %>% plotly::ggplotly() %>% 
  plotly::layout(showlegend = FALSE,
                 # margin = list(l = 150),
                 yaxis = list(title = "Phi")
                 )

p_phi$x$data[[51]]$text <- gsub('red','Mean of all states', p_phi$x$data[[51]]$text)

# p_phi
```


```{r}
all_psi <- state_summaries %>%
  filter(variable == "latent_trend") %>%
  dplyr::select(location, date, mean_value) %>%
  rename(psi = mean_value) %>% 
  filter(date <= Sys.Date())

mean_psi <- all_psi %>% group_by(date) %>% summarise(psi = mean(psi))

g_psi <- ggplot(all_psi, aes(x = date, y = psi, color = location)) +
  geom_line(size = 0.5) +
  # ylab("Latent trend\n(% of normal)") +
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  scale_color_viridis_d(option = "D", direction = -1, alpha = .6, end = .75) +
  # theme_dark(base_line_size = 0.5) +
  geom_line(data = mean_psi, alpha = .6, size = 2, color = 'red') +
  annotate("rect", xmin = future[1], xmax = future[2], ymin = 0, ymax = 1, alpha = .2) +
  theme_minimal() +
  guides(color = FALSE)

p_psi <- g_psi %>% plotly::ggplotly() %>% 
  plotly::layout(showlegend = FALSE,
                 # margin = list(l = 150),
                 yaxis = list(title = "Psi")
                 )

p_psi$x$data[[51]]$text <- gsub('red','Mean of all states', p_psi$x$data[[51]]$text)

# p_psi
```


```{r}
all_omega <- state_summaries %>%
  filter(variable == "omega") %>%
  dplyr::select(location, date, mean_value) %>%
  rename(omega = mean_value) %>% 
  filter(date <= Sys.Date())

mean_omega <- all_omega %>% group_by(date) %>% summarise(omega = mean(omega))

max_omega <- max(all_omega$omega)

g_omega <- ggplot(all_omega, aes(x = date, y = omega, color = location)) +
  geom_line(size = 0.5) +
  # ylab("Latent trend\n(% of normal)") +
  # scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  scale_color_viridis_d(option = "D", direction = -1, alpha = .6, end = .75) +
  # theme_dark(base_line_size = 0.5) +
  geom_line(data = mean_omega, alpha = .6, size = 2, color = 'red') +
  annotate("rect", xmin = future[1], xmax = future[2], ymin = 0, ymax = all_omega$omega, alpha = .2) +
  theme_minimal() +
  guides(color = FALSE)

p_omega <- g_omega %>% plotly::ggplotly() %>% 
  plotly::layout(showlegend = FALSE,
                 # margin = list(l = 150),
                 yaxis = list(title = "Omega")
                 )

p_omega$x$data[[51]]$text <- gsub('red','Mean of all states', p_omega$x$data[[51]]$text)

# p_omega
```

```{r}
plotly::subplot(p_phi, p_psi, p_omega, nrows = 3, shareX = TRUE, titleY = TRUE)
```

# Correlation between Omega and Prevalence

Sample period = March 1, 2020 through December 31, 2021

a) predictor = omega(t); response = daily prevalence(t)

```{r}

all_prevalence <- state_summaries %>%
  filter(period == "Past") %>%
  filter(between(date, sample_period[1], sample_period[2])) %>% 
  filter(variable == "prevalence") %>%
  dplyr::select(location, date, mean_value) %>%
  rename(prevalence = mean_value) %>% 
  filter(date <= Sys.Date())

mean_all_prevalence <- all_prevalence %>% group_by(date) %>% summarise(prevalence = mean(prevalence))
# plot(x = mean_omega$mean_value, y = mean_all_prevalence$prevalence)

means <- mean_phi %>% 
  full_join(mean_psi) %>% 
  full_join(mean_omega) %>% 
  full_join(mean_all_prevalence)

state_summaries_wide <- state_summaries %>%
  filter(period == "Past") %>%
  filter(between(date, sample_period[1], sample_period[2])) %>% 
  filter(sim_type == 'status_quo') %>% 
  pivot_wider(names_from = variable, values_from = mean_value) %>% 
  group_by(location) %>% 
  mutate(AU_omega = cumsum(omega))

CA <- state_summaries_wide %>% filter(location == "California")

lagfill <- function(x, lag,fill=1) {
  replace_na(lag(x,lag),fill)
}

CA %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(omega,0), y = ~prevalence, 
                hoverinfo = 'text', 
                text = ~paste('</br> Omega: ', omega, '</br> prevalence: ', prevalence, '</br> Date: ', date)) %>% 
  plotly::layout(title = "California",xaxis=list(title="omega"),yaxis=list(title="prevalence"))

state_summaries_wide %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(omega,0), y = ~prevalence, color = ~location,
                hoverinfo = 'text', 
                text = ~paste('</br> Omega: ', omega, '</br> prevalence: ', prevalence, '</br> Date: ', date, '</br> State: ', location )) %>% 
    plotly::layout(title = "All states", xaxis=list(title="omega"),yaxis=list(title="prevalence"))

means %>% filter(date < future[1]) %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~omega, y = ~prevalence,                
                hoverinfo = 'text', 
                text = ~paste('</br> Omega: ', omega, '</br> prevalence: ', prevalence, '</br> Date: ', date )) %>% 
  plotly::layout(title = "Mean omega, mean prevalence (across states)",xaxis=list(title="omega"),yaxis=list(title="prevalence"))

```

---

California, and mean across states, at varying lags

```{r}
CA %>% filter(period == 'Past') %>% 
  filter(between(date, sample_period[1], sample_period[2])) %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(omega,0), y = ~prevalence, name = "lag 0",
                hoverinfo = 'text', text = ~paste('</br> Omega: ', omega, '</br> prevalence: ', prevalence, '</br> Date: ', date)) %>% 
  plotly::add_trace(x = ~lagfill(omega,7), y = ~prevalence, name = "lag 7") %>% 
  plotly::add_trace(x = ~lagfill(omega,14), y = ~prevalence, name = "lag 14") %>% 
  plotly::add_trace(x = ~lagfill(omega,21), y = ~prevalence, name = "lag 21") %>% 
  plotly::add_trace(x = ~lagfill(omega,28), y = ~prevalence, name = "lag 28") %>% 
  plotly::layout(title = "California, omega at varying lags", xaxis = list(title = "omega"))

means %>% filter(date < future[1]) %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(omega,0), y = ~prevalence, name = "lag 0",
                hoverinfo = 'text', text = ~paste('</br> Omega: ', omega, '</br> prevalence: ', prevalence, '</br> Date: ', date)) %>% 
  plotly::add_trace(x = ~lagfill(omega,7), y = ~prevalence, name = "lag 7") %>% 
  plotly::add_trace(x = ~lagfill(omega,14), y = ~prevalence, name = "lag 14") %>% 
  plotly::add_trace(x = ~lagfill(omega,21), y = ~prevalence, name = "lag 21") %>% 
  plotly::add_trace(x = ~lagfill(omega,28), y = ~prevalence, name = "lag 28") %>% 
  plotly::layout(title = "Mean omega, mean prevalence (across states)\nomega at varying lags", xaxis = list(title = "omega"))

```

---

b) predictor = AUC of omega over time; response = cumulative all infections over time

```{r}

CA %>% filter(period == 'Past') %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(AU_omega,0), y = ~cumulative_all_infections, name = 'lag 0', 
                hoverinfo = 'text', 
                text = ~paste('</br> Area under Omega: ', AU_omega, 
                              '</br> Cumulative infections: ', cumulative_all_infections, 
                              '</br> Date: ', date)) %>% 
  plotly::add_trace(x = ~lagfill(AU_omega,7), y = ~cumulative_all_infections, name = "lag 7") %>% 
  plotly::add_trace(x = ~lagfill(AU_omega,14), y = ~cumulative_all_infections, name = "lag 14") %>% 
  plotly::add_trace(x = ~lagfill(AU_omega,21), y = ~cumulative_all_infections, name = "lag 21") %>% 
  plotly::add_trace(x = ~lagfill(AU_omega,28), y = ~cumulative_all_infections, name = "lag 28") %>% 
  plotly::add_trace(x = ~lagfill(AU_omega,56), y = ~cumulative_all_infections, name = "lag 56") %>% 
  plotly::layout(title = "California, area under omega at varying lags",xaxis=list(title="Area under omega"),yaxis=list(title="Cumulative infections"))

state_summaries_wide %>% filter(period == 'Past') %>% 
  filter(date > burnin[2]) %>%
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~lagfill(AU_omega,0), y = ~cumulative_all_infections, color = ~location,
                hoverinfo = 'text', 
                text = ~paste('</br> Area under Omega: ', AU_omega, 
                              '</br> Cumulative infections: ', cumulative_all_infections, 
                              '</br> Date: ', date,
                              '</br> State: ', location)) %>% 
    plotly::layout(title = "All states", xaxis=list(title="Area under omega (lag 0)"), yaxis=list(title="Cumulative infections"))


```

---

c) predictor = AUC of omega; response = cumulative all infections

```{r}
# state_summaries_wide %>% 
#   filter(period == 'Past') %>%
#   filter(date > burnin[2]) %>%
#   group_by(location) %>% 
#   summarise(AU_omega = max(AU_omega), cumulative_all_infections = max(cumulative_all_infections)) %>% 
#   plotly::plot_ly(type = 'scatter', mode = 'markers',
#                 x = ~AU_omega, y = ~cumulative_all_infections,
#                 hoverinfo = 'text', 
#                 text = ~paste('</br> Area under Omega: ', AU_omega, 
#                               '</br> Cumulative infections: ', cumulative_all_infections, 
#                               '</br> State: ', location)) %>% 
#     plotly::layout(title = "Correlation of cumulative infection with Area under omega", xaxis=list(title="Area under omega"), yaxis=list(title="Cumulative infections"))

state_summaries_wide %>% 
  filter(period == 'Past') %>%
#  filter(date > burnin[2]) %>%
  filter(date >= sample_period[1] & date <= sample_period[2]) %>% 
  group_by(location) %>% 
  summarise(AU_omega = max(AU_omega), cumulative_all_infections = max(cumulative_all_infections)) %>% 
  ggstatsplot::ggscatterstats(x = "AU_omega", y = "cumulative_all_infections", type = "spearman", 
                              title = "Correlation of cumulative infections with Area under omega")

```

---

e) map of same (correlation, by state)

To be made

# Correlation between Mobility and Omega

```{r}

CA %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~mobility_trend, y = ~omega, 
                hoverinfo = 'text', 
                text = ~paste('</br> Mobility: ', mobility_trend, '</br> omega: ', omega, '</br> Date: ', date)) %>% 
  plotly::layout(title = "California",xaxis=list(title="mobility trend"),yaxis=list(title="omega"))

CA %>% ungroup() %>% filter(date < future[1]) %>% 
  filter(date > burnin[2]) %>%
  select(date,mobility_trend,omega) %>% 
  ggstatsplot::ggscatterstats(x = "mobility_trend", y = "omega", type = "spearman", title = "California")


state_summaries_wide %>% 
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~mobility_trend, y = ~omega, color = ~location,
                hoverinfo = 'text', 
                text = ~paste('</br> Mobility: ', mobility_trend, '</br> omega: ', omega, '</br> Date: ', date, '</br> State: ', location )) %>%
    plotly::layout(title = "All states", xaxis=list(title="mobility trend"),yaxis=list(title="omega"))

means %>% 
  filter(date < future[1]) %>% 
  filter(date > as.Date("2020-02-25")) %>% # Feb 26 is the first day with any mobility < 1
  plotly::plot_ly(type = 'scatter', mode = 'markers',
                x = ~phi, y = ~omega,                
                hoverinfo = 'text', 
                text = ~paste('</br> Mobility: ', phi, '</br> omega: ', omega, '</br> Date: ', date)) %>% 
  plotly::layout(title = "Mean mobility, mean omega (across states)",xaxis=list(title="mobility trend"),yaxis=list(title="omega"))

```

```{r}
# means %>% filter(date < future[1]) %>% 
#   filter(date > burnin[2]) %>%
#   ggscatterhist(x = "phi", y = "omega", 
#           color = "black", fill = NA, shape = 19, size = 3, # points
#           add = "reg.line", 
#           add.params = list(color = "blue", fill = "lightgray"),
#           conf.int = TRUE, 
#           cor.coef = TRUE, cor.method = "spearman",
#           xlab = "mobility trend", ylab = "omega",
#           margin.plot = "density",
#           margin.ggtheme = theme_void(),
#           margin.space = FALSE,
#           main.plot.size = 2,
#           margin.plot.size = 1
#           )

means %>% filter(date < future[1]) %>% 
  filter(date > burnin[2]) %>%
  ggstatsplot::ggscatterstats(x = "phi", y = "omega", type = "spearman", title = "Mean phi, Mean omega over all states")


```

# R effective for all states

```{r R_effective, fig.height=3, fig.width=7, eval = TRUE}
all_re <- state_summaries %>%
  filter(variable == "R_e") %>%
  dplyr::select(location, date, mean_value) %>%
  rename(R_e = mean_value) %>% 
  filter(date <= Sys.Date()) %>% 
  left_join(statedf, by=c("location" = "state_full")) %>% 
  mutate(relative_pop = total_pop / allstates_pop)

mean_re <- all_re %>% group_by(date) %>% summarise(R_e = mean(R_e))

weighted_mean_re <- all_re %>% group_by(date) %>% summarise(R_e = sum(R_e*relative_pop))

g_re <- ggplot(all_re, aes(x = date, y = R_e, color = location)) +
  geom_line(size = 0.5) +
  scale_y_continuous(limits = c(0,5)) +
  scale_color_viridis_d(option = "D", direction = -1, alpha = .6, end = .75) +
  # theme_dark(base_line_size = 0.5) +
  geom_line(data = weighted_mean_re, alpha = .6, size = 2, color = 'red') +
  # geom_rect(aes(xmin=future[1], xmax=future[2], ymin=0, ymax=1)) +
  annotate("rect", xmin = future[1], xmax = future[2], ymin = 0, ymax = 5, alpha = .2) +
  geom_hline(yintercept = 1) +
  theme_minimal() +
  guides(color = FALSE)

p_re <- g_re %>% plotly::ggplotly() %>% 
  plotly::layout(showlegend = TRUE,
                 # margin = list(l = 150),
                 yaxis = list(title = "R_e")
                 )

p_re$x$data[[51]]$text <- gsub('red','Weighted mean of all states', p_re$x$data[[51]]$text)

p_re
```


# Cross Correlation among times series of R Effective

```{r}
all_re_wide <- all_re %>% 
  select(date, location, R_e) %>% 
  pivot_wider(names_from = location, values_from = R_e) %>% 
  select(-date)

westernstates <- all_re_wide %>% select(c("Washington","Oregon","California"))
CA_FL <- all_re_wide %>% select(c("California","Florida"))


ccfmatrix <- function(x){
  # init matrix of acf objects and matrix of ggplots
  mlist <- glist <- matrix(list(), ncol = ncol(x), nrow = ncol(x))
  
  # fill matrix with pairwise cross correlation functions
  for(i in 1:ncol(x)){
    for(j in 1:ncol(x)){
      ccf <- ccf(x = x[,i], y= x[,j], na.action = na.pass, plot = FALSE)
      g <- ggplot2::autoplot(ccf) + theme_minimal() +
        ylim(-1,1) + 
        labs(title=paste0(names(x)[i]," ", names(x)[j]), x = "", y="") +
        theme(
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          plot.margin = unit(c(0,0,0,0), "cm")
          )
      mlist[i,j] <- list(ccf)
      glist[j,i] <- list(g)
    }
  }
  return(list(data=mlist,plots=glist))
}

# calculate cross correlation functions for each state pair
n <- 4
re_ccf_matrix <- ccfmatrix(all_re_wide[,1:n])
  
# plot CCF for a pair of states
# g1 <- re_ccf_matrix[1,2][[1]] %>% ggplot2::autoplot()+labs(title="", x = "", y="")

# grobs <- list(g1,g1,g1,g1)

plot_ccf_matrix <- function(x) {
  gridExtra::grid.arrange(
    grobs=x$plots,
    nrow=ncol(x$data),
    ncol=ncol(ncol(x$data))
    )
}
  
ccfmatrix(all_re_wide[,c("Delaware","Georgia")]) %>% plot_ccf_matrix()

```

# Correlation among times series of R Effective

```{r}
all_re_wide <- all_re %>% 
  select(date, location, R_e) %>% 
  pivot_wider(names_from = location, values_from = R_e) %>% 
  select(-date)

corrmatrix <- cor(all_re_wide, use = "complete.obs")

heatmap(corrmatrix, scale = "none")

# Reorder the correlation matrix
cormat <- reorder_cormat(cormat)


# reorder_cormat <- function(cormat){
# # Use correlation between variables as distance
# dd <- as.dist((1-cormat)/2)
# hc <- hclust(dd)
# cormat <-cormat[hc$order, hc$order]
# }
# 
# upper_tri <- get_upper_tri(cormat)
# # Melt the correlation matrix
# melted_cormat <- melt(upper_tri, na.rm = TRUE)
# # Create a ggheatmap
# ggheatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
#  geom_tile(color = "white")+
#  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
#    midpoint = 0, limit = c(-1,1), space = "Lab", 
#     name="Pearson\nCorrelation") +
#   theme_minimal()+ # minimal theme
#  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
#     size = 12, hjust = 1))+
#  coord_fixed()
# # Print the heatmap
# print(ggheatmap)

```

# Are pairwise state R_e correlation coefficients correlated with the distances between state centroids?
